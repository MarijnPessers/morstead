using EasyCompressor;
using Orleans.TestingHost;
using System.Net.Mime;
using System.Text;
using Vs.Morstead.Grains.Interfaces.Content;
using Vs.Morstead.Tests;
using Xunit;

namespace Vs.Morstead.Tests.Content
{
    public class PublicationTests : IClassFixture<ClusterFixture>
    {
        private readonly TestCluster cluster;

        public PublicationTests(ClusterFixture fixture)
        {
            cluster = fixture.Cluster;
        }

        [Fact]
        public async void ShouldPersistPublication()
        {
            string target = "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";
            var grain = cluster.GrainFactory.GetGrain<IContentPersistentGrain>("did:vsoc:mstd:pub:Sp8WbN5r0E6MCEx54Is3oQ");
            await grain.Save(new ContentType("application/yaml"), Encoding.UTF8, target);
            var grain2 = cluster.GrainFactory.GetGrain<IContentPersistentGrain>("did:vsoc:mstd:pub:Sp8WbN5r0E6MCEx54Is3oQ");
            var document = await grain2.Load();
            LZ4Compressor comp = new LZ4Compressor("", K4os.Compression.LZ4.LZ4Level.L12_MAX);
            var contents = document.Encoding.GetString(comp.Decompress(document.Content));
            Assert.Equal(contents, target);
        }
    }
}
